name: Add publication (DOI) -> assign Copilot

on:
  workflow_dispatch:
    inputs:
      doi:
        description: "DOI (e.g. 10.1234/abcd.5678 or https://doi.org/10.1234/abcd.5678)"
        required: true
        type: string
      target_branch:
        description: "Which branch Copilot should target for its PR"
        required: true
        type: choice
        options:
          - main
          - drops
        default: drops

jobs:
  assign:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Normalize DOI + quick duplicate check
        id: norm
        run: |
          set -euo pipefail
          doi="${{ inputs.doi }}"

          # normalize common prefixes + whitespace
          doi="$(echo "$doi" | tr -d '\r' | sed -E 's#^https?://(dx\.)?doi\.org/##i; s#^doi:##i' | xargs)"
          doi_lc="$(echo "$doi" | tr '[:upper:]' '[:lower:]')"

          echo "doi=$doi_lc" >> "$GITHUB_OUTPUT"

          # quick precheck: if DOI already appears anywhere in publications data, stop here
          if grep -R -n -i -F "$doi_lc" src/data/publications >/dev/null 2>&1; then
            echo "DOI already exists in src/data/publications. Not creating Copilot issue."
            exit 0
          fi

      - name: Create issue + assign Copilot agent
        env:
          GH_TOKEN: ${{ secrets.COPILOT_AGENT_TOKEN }} # fine-grained PAT (user token)
          DOI: ${{ steps.norm.outputs.doi }}
          TARGET_BRANCH: ${{ inputs.target_branch }}
        run: |
          set -euo pipefail
          OWNER="${GITHUB_REPOSITORY%/*}"
          REPO="${GITHUB_REPOSITORY#*/}"

          title="Ingest publication DOI: ${DOI}"

          body="$(jq -rn --arg doi "$DOI" '
            [
              "Please ingest this publication into the website data model.",
              "",
              "**DOI:** `\($doi)`",
              "",
              "## Steps",
              "1) Duplicate check: scan `src/data/publications/**` and confirm this DOI is not already present. If present, comment and stop (no PR).",
              "2) If new: add it under `src/data/publications/doi/` using `scripts/add_doi_publication.ts` (and any other relevant scripts under `scripts/`).",
              "3) Enrich authors using `scripts/enrich_publications_with_authors.ts`.",
              "4) Cross-reference publication authors with `people.ts`. Prefer ORCID match; otherwise be conservative. If zero matches, comment and stop (no PR).",
              "5) Classify the publication against themes in `researchProjects.ts` (use title + shortDescription).",
              "6) Append the new publication ID to the chosen themeâ€™s `publicationIds` array.",
              "",
              "## Acceptance criteria",
              "- Minimal changes only (no refactors).",
              "- If you stop early, explain why in an issue comment."
            ] | join("\n")
          ')"

          payload="$(jq -n \
            --arg title "$title" \
            --arg body "$body" \
            --arg target_repo "${OWNER}/${REPO}" \
            --arg base_branch "$TARGET_BRANCH" \
            '{
              title: $title,
              body: $body,
              assignees: ["copilot-swe-agent[bot]"],
              agent_assignment: {
                target_repo: $target_repo,
                base_branch: $base_branch,
                custom_instructions: ""
              }
            }'
          )"

          gh api \
            --method POST \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "/repos/${OWNER}/${REPO}/issues" \
            --input - <<<"$payload"
