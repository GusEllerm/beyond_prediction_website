name: Copilot agent smoke test (create PR)

on:
  workflow_dispatch:
    inputs:
      file_path:
        description: "Path to create (relative to repo root)"
        required: true
        default: "agent_test.txt"
      file_contents:
        description: "Contents for the file"
        required: true
        default: "hello from copilot coding agent\n"

jobs:
  create_issue_and_assign_agent:
    runs-on: ubuntu-latest

    steps:
      - name: Create an issue assigned to Copilot coding agent
        env:
          # IMPORTANT: this must be a USER token (PAT or GitHub App user token),
          # not the default GITHUB_TOKEN.
          GH_TOKEN: ${{ secrets.COPILOT_AGENT_TOKEN }}

          OWNER: ${{ github.repository_owner }}
          REPO: ${{ github.event.repository.name }}
          BASE_BRANCH: main

          FILE_PATH: ${{ inputs.file_path }}
          FILE_CONTENTS: ${{ inputs.file_contents }}
        run: |
          set -euo pipefail

          title="Agent test: create ${FILE_PATH}"
          body=$(cat <<EOF
                      
          Please create a PR that:

          - Adds a new text file at: \`${FILE_PATH}\`
          - File contents (exact):
          \`\`\`
          ${FILE_CONTENTS}
          \`\`\`

          Acceptance criteria:
          - The PR contains only this change (no refactors).
          - The build/lint configuration is untouched.
          EOF
                    )

                    payload=$(jq -n \
                      --arg title "$title" \
                      --arg body "$body" \
                      --arg target_repo "${OWNER}/${REPO}" \
                      --arg base_branch "${BASE_BRANCH}" \
                      '{
                        title: $title,
                        body: $body,
                        assignees: ["copilot-swe-agent[bot]"],
                        agent_assignment: {
                          target_repo: $target_repo,
                          base_branch: $base_branch,
                          custom_instructions: "",
                          custom_agent: "",
                          model: ""
                        }
                      }')

                    echo "$payload" | gh api \
                      --method POST \
                      -H "Accept: application/vnd.github+json" \
                      -H "X-GitHub-Api-Version: 2022-11-28" \
                      "/repos/${OWNER}/${REPO}/issues" \
                      --input -
